# Премиум-услуги FATOS.pro

## Обзор

Модуль премиум-услуг предоставляет пользователям возможность приобрести расширенные функции платформы через интеграцию с платежными системами ЮKassa и Stripe.

## Компоненты

### PremiumServices

Главный компонент для отображения карточек премиум-услуг на главной странице.

**Расположение**: `components/PremiumServices.tsx`

**Функциональность**:
- Отображает 3 карточки услуг:
  1. Полный Квадрат Пифагора (490 ₽ / 7 EUR)
  2. Матрица Судьбы (490 ₽ / 7 EUR)
  3. Личная консультация (по запросу)
- Обрабатывает клики по кнопкам "Купить"
- Открывает модальное окно оплаты для платных услуг
- Перенаправляет на email для консультаций

### PaymentModal

Модальное окно для выбора способа оплаты и инициации платежа.

**Расположение**: `components/PaymentModal.tsx`

**Функциональность**:
- Отображает информацию о выбранной услуге
- Предлагает выбор между ЮKassa (для РФ) и Stripe (международные)
- Создает платежную сессию через API `/api/payments/create`
- Перенаправляет пользователя на страницу оплаты
- Обрабатывает ошибки и отображает их пользователю

## Интеграция

### Главные страницы

Компонент `PremiumServices` добавлен на обе главные страницы:
- `/ru` (русская версия)
- `/en` (английская версия)

Расположен после компонента `Calculator` с отступом `mt-12 sm:mt-16`.

### Переводы

Добавлены новые ключи переводов в `messages/ru.json` и `messages/en.json`:

```json
{
  "premium": {
    "title": "Премиум услуги",
    "subtitle": "Откройте полный потенциал нумерологии...",
    "fullPythagorean": "Полный Квадрат Пифагора",
    "destinyMatrix": "Матрица Судьбы",
    "consultation": "Личная консультация",
    "features": { ... },
    "buy": "Купить",
    "choosePaymentMethod": "Выберите способ оплаты",
    ...
  }
}
```

## Процесс оплаты

1. **Выбор услуги**: Пользователь нажимает "Купить" на карточке услуги
2. **Модальное окно**: Открывается `PaymentModal` с выбором способа оплаты
3. **Выбор провайдера**: 
   - ЮKassa (490 ₽) - для пользователей из России
   - Stripe (7 EUR) - для международных платежей
4. **Создание сессии**: POST запрос к `/api/payments/create` с параметрами:
   ```json
   {
     "amount": 49000, // в копейках/центах
     "currency": "RUB" | "EUR",
     "countryCode": "RU" | "OTHER",
     "serviceId": "full_pythagorean" | "destiny_matrix"
   }
   ```
5. **Перенаправление**: Пользователь перенаправляется на страницу оплаты платежной системы
6. **Обработка результата**: После оплаты вебхук обновляет статус заказа в БД

## Требования

### Аутентификация

Для совершения покупки пользователь должен быть авторизован. Если пользователь не авторизован, отображается ошибка "Для оплаты необходимо войти в систему".

### Переменные окружения

Необходимы следующие переменные:
- `YUKASSA_SHOP_ID` - ID магазина ЮKassa
- `YUKASSA_SECRET_KEY` - Секретный ключ ЮKassa
- `STRIPE_SECRET_KEY` - Секретный ключ Stripe
- `STRIPE_WEBHOOK_SECRET` - Секрет для вебхуков Stripe
- `NEXT_PUBLIC_BASE_URL` - Базовый URL приложения

## Будущие улучшения

### Разблокировка контента

✅ **РЕАЛИЗОВАНО** - После успешной оплаты контент автоматически разблокируется:

1. **Модель Purchase в БД** ✅:
   - Добавлена модель Purchase в `prisma/schema.prisma`
   - Создана миграция `add_purchase_model.sql`
   - Связь с User и Order через внешние ключи

2. **Проверка доступа** ✅:
   - Создан хук `usePurchases()` в `lib/hooks/usePurchases.ts`
   - Добавлена проверка в компонент `PythagoreanSquareDisplay`
   - Скрытие/показ ячеек на основе наличия покупки
   - Бесплатные ячейки: 1, 5, 9 (диагональ)

3. **Страницы успеха/отмены** ✅:
   - `/ru/payment/success` - отображение успешной оплаты
   - `/ru/payment/cancel` - отображение отмененной оплаты
   - `/en/payment/success` - английская версия успеха
   - `/en/payment/cancel` - английская версия отмены

4. **API эндпоинты** ✅:
   - `GET /api/purchases` - получение списка покупок пользователя
   - Автоматическое создание Purchase при успешной оплате в вебхуках

5. **Интеграция с платежными системами** ✅:
   - Обновлены StripeProvider и YuKassaProvider
   - Добавлена передача serviceId и locale
   - Настроены URL возврата с параметрами заказа

### Дополнительные улучшения (TODO)

4. **Уведомления**:
   - Email-уведомление после успешной оплаты
   - Уведомление в интерфейсе о разблокированном контенте

## Тестирование

### Тестовые данные

Для тестирования используйте тестовые карты:
- **ЮKassa**: [Тестовые карты ЮKassa](https://yookassa.ru/developers/payment-acceptance/testing-and-going-live/testing)
- **Stripe**: [Тестовые карты Stripe](https://stripe.com/docs/testing)

### Проверка функциональности

1. Открыть главную страницу
2. Прокрутить до блока "Премиум услуги"
3. Нажать "Купить" на любой карточке
4. Выбрать способ оплаты
5. Проверить создание заказа в БД
6. Проверить перенаправление на страницу оплаты

## Безопасность

- Все платежи проходят через защищенное HTTPS соединение
- Подписи вебхуков верифицируются перед обработкой
- Секретные ключи хранятся в переменных окружения
- Пользовательские данные не передаются платежным системам напрямую
