# Коллекция Арканов

## Обзор

Функция "Коллекция Арканов" позволяет пользователям собирать уникальные арканы (1-22) при каждом расчете Карты дня. Это геймификационная функция, которая мотивирует пользователей возвращаться на платформу ежедневно.

## Компоненты

### 1. База данных

**Модель: CollectedArcana**
```prisma
model CollectedArcana {
  id              String        @id @default(cuid())
  userId          String
  arcanaNumber    Int           // 1-22
  firstSeenAt     DateTime      @default(now())
  
  user            User          @relation(fields: [userId], references: [id])
  
  @@unique([userId, arcanaNumber])
  @@index([userId])
}
```

### 2. API Endpoints

#### POST /api/arcana/collect
Сохраняет новые уникальные арканы для пользователя.

**Request:**
```json
{
  "userId": "user-id",
  "arcanaNumbers": [1, 5, 12, 22]
}
```

**Response:**
```json
{
  "success": true,
  "newArcanas": 2,
  "collected": [1, 5]
}
```

#### GET /api/arcana/collection?userId={userId}
Получает полную коллекцию арканов пользователя.

**Response:**
```json
{
  "total": 22,
  "collected": 8,
  "progress": 36,
  "arcanas": [
    {
      "number": 1,
      "collected": true,
      "firstSeenAt": "2024-01-15T10:30:00Z"
    },
    {
      "number": 2,
      "collected": false,
      "firstSeenAt": null
    }
    // ... остальные арканы
  ]
}
```

### 3. React Components

#### ArcanaCollection
Компонент для отображения коллекции арканов с прогресс-баром.

**Props:**
- `userId: string` - ID пользователя

**Функции:**
- Отображает прогресс-бар (X/22 собранных)
- Показывает сетку всех 22 арканов
- Визуально выделяет собранные арканы
- Показывает дату первого получения при наведении
- Отображает поздравление при полной коллекции

#### Calculator (обновлен)
Компонент калькулятора теперь автоматически сохраняет арканы после расчета.

**Новые props:**
- `userId?: string` - Опциональный ID пользователя для сохранения арканов

**Логика:**
- При выполнении расчета Карты дня (4 аркана: утро, день, вечер, ночь)
- Если userId предоставлен, автоматически вызывает API для сохранения арканов
- Обрабатывает ошибки без прерывания основного потока

### 4. Страницы профиля

Созданы страницы профиля для обоих языков:
- `/ru/profile` - Русская версия
- `/en/profile` - Английская версия

## Использование

### Для разработчиков

1. **Добавить userId в Calculator:**
```tsx
<Calculator userId={currentUser.id} />
```

2. **Отобразить коллекцию в профиле:**
```tsx
<ArcanaCollection userId={currentUser.id} />
```

### Для пользователей

1. Выполните расчет на главной странице
2. Перейдите в "Моя коллекция арканов"
3. Просмотрите собранные арканы и прогресс
4. Возвращайтесь ежедневно для сбора новых арканов

## Технические детали

### Уникальность
- Используется unique constraint на `(userId, arcanaNumber)`
- Повторные попытки сохранить тот же аркан игнорируются
- Не создаются дубликаты в базе данных

### Производительность
- API endpoint использует batch insert для эффективности
- Индексы на `userId` для быстрого поиска
- Клиентское кеширование через React state

### Безопасность
- Валидация arcanaNumber (1-22)
- Проверка userId перед сохранением
- Обработка ошибок без раскрытия внутренней структуры

## Будущие улучшения

1. **Аутентификация**: Интеграция с реальной системой аутентификации
2. **Уведомления**: Push-уведомления о новых арканах
3. **Статистика**: Показывать редкость арканов
4. **Награды**: Бонусы за полную коллекцию
5. **Социальные функции**: Сравнение коллекций с друзьями

## Миграция базы данных

Для применения изменений в базе данных:

```bash
npx prisma migrate dev --name add-collected-arcana
npx prisma generate
```

## Тестирование

Для тестирования используйте demo user ID: `demo-user-123`

Этот ID уже настроен на страницах `/ru` и `/en` для демонстрации функциональности.
