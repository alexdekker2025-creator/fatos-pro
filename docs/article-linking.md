# Связывание статей с результатами расчетов

Руководство по связыванию статей с нумерологическими значениями в FATOS.pro.

## Обзор

Система связывания статей позволяет отображать описания и интерпретации для:
- Чисел судьбы (1-9, 11, 22, 33)
- Позиций матрицы судьбы (8 позиций)
- Ячеек квадрата Пифагора (цифры 1-9 с разным количеством повторений)

## Формат relatedValue

Поле `relatedValue` в таблице `Article` используется для связывания статей с нумерологическими значениями.

### Число судьбы

**Формат**: `destiny_{число}`

**Примеры**:
- `destiny_1` - статья для числа судьбы 1
- `destiny_5` - статья для числа судьбы 5
- `destiny_11` - статья для мастер-числа 11
- `destiny_22` - статья для мастер-числа 22
- `destiny_33` - статья для мастер-числа 33

**Всего**: 12 статей (1-9, 11, 22, 33)

### Позиции матрицы судьбы

**Формат**: `matrix_{позиция}_{значение}`

**Позиции**:
- `dayNumber` - Число дня
- `monthNumber` - Число месяца
- `yearNumber` - Число года
- `lifePathNumber` - Число жизненного пути
- `personalityNumber` - Число личности
- `soulNumber` - Число души
- `powerNumber` - Число силы
- `karmicNumber` - Кармическое число

**Примеры**:
- `matrix_dayNumber_5` - статья для числа дня = 5
- `matrix_lifePathNumber_11` - статья для числа жизненного пути = 11
- `matrix_soulNumber_7` - статья для числа души = 7

**Всего**: 8 позиций × 12 значений (1-9, 11, 22, 33) = 96 статей

### Ячейки квадрата Пифагора

**Формат**: `square_{цифра}_{количество}`

**Примеры**:
- `square_1_0` - статья для цифры 1 с 0 повторений (отсутствует)
- `square_1_1` - статья для цифры 1 с 1 повторением
- `square_1_2` - статья для цифры 1 с 2 повторениями
- `square_5_3` - статья для цифры 5 с 3 повторениями

**Всего**: 9 цифр × ~5 вариантов количества = ~45 статей

## API

### GET /api/articles

Получить статьи по связанному значению.

**Query параметры**:
- `relatedValue` (обязательный) - значение для поиска
- `language` (опциональный) - язык статей (ru или en, по умолчанию ru)

**Пример запроса**:
```bash
GET /api/articles?relatedValue=destiny_5&language=ru
```

**Пример ответа**:
```json
{
  "articles": [
    {
      "id": "clx123abc456",
      "title": "Число судьбы 5: Свобода и перемены",
      "content": "Люди с числом судьбы 5...",
      "category": "destiny_number",
      "language": "ru",
      "relatedValue": "destiny_5",
      "publishedAt": "2024-01-01T00:00:00.000Z",
      "updatedAt": "2024-01-01T00:00:00.000Z"
    }
  ]
}
```

## Использование в коде

### ArticleService

```typescript
import { ArticleService } from '@/lib/services/articles';

const articleService = new ArticleService();

// Получить статью для числа судьбы
const destinyArticle = await articleService.getDestinyNumberArticle(5, 'ru');

// Получить статью для позиции матрицы
const matrixArticle = await articleService.getMatrixPositionArticle('dayNumber', 5, 'ru');

// Получить статью для ячейки квадрата
const squareArticle = await articleService.getSquareCellArticle(1, 3, 'ru');

// Получить все статьи для результатов расчетов
const articles = await articleService.getArticlesForCalculation(
  {
    destinyNumber: { value: 5 },
    matrix: { positions: new Map([['dayNumber', 5]]) },
    square: { digitCounts: new Map([[1, 3]]) },
  },
  'ru'
);
```

### useArticles Hook

```typescript
import { useArticles } from '@/lib/hooks/useArticles';

function MyComponent() {
  const { 
    getDestinyNumberArticle, 
    getMatrixPositionArticle, 
    getSquareCellArticle,
    loading,
    error 
  } = useArticles();

  const loadArticles = async () => {
    const destinyArticle = await getDestinyNumberArticle(5, 'ru');
    const matrixArticle = await getMatrixPositionArticle('dayNumber', 5, 'ru');
    const squareArticle = await getSquareCellArticle(1, 3, 'ru');
  };

  return (
    <div>
      {loading && <p>Загрузка...</p>}
      {error && <p>Ошибка: {error}</p>}
    </div>
  );
}
```

## Интеграция в Calculator

Компонент `Calculator` автоматически загружает статьи после выполнения расчетов:

1. Выполняются нумерологические расчеты
2. Вызывается функция `loadArticles()` с результатами
3. Статьи загружаются параллельно для всех значений
4. Статьи отображаются в соответствующих секциях результатов

### Отображение статей

**Число судьбы**:
- Статья отображается под числом судьбы
- Показывается заголовок и полный текст

**Матрица судьбы**:
- Иконка ℹ️ отображается на карточках позиций, для которых есть статьи
- Статьи отображаются под сеткой матрицы
- Каждая статья включает название позиции, значение, заголовок и текст

**Квадрат Пифагора**:
- Иконка ℹ️ отображается на ячейках, для которых есть статьи
- Статьи отображаются под квадратом (только для пользователей с полным доступом)
- Каждая статья включает цифру, заголовок и текст

## Создание статей через админ панель

1. Перейти на `/admin`
2. Открыть вкладку "Статьи"
3. Нажать "Создать статью"
4. Заполнить форму:
   - **Заголовок**: краткое название (например, "Число судьбы 5")
   - **Содержание**: полный текст интерпретации
   - **Категория**: `destiny_number`, `matrix_position` или `square_cell`
   - **Язык**: `ru` или `en`
   - **Связанное значение**: формат согласно таблице выше
5. Нажать "Сохранить"

## Примеры статей

### Число судьбы 5

```
Заголовок: Число судьбы 5: Свобода и перемены
Категория: destiny_number
Язык: ru
Связанное значение: destiny_5

Содержание:
Люди с числом судьбы 5 - это искатели приключений и перемен. Они ценят свободу превыше всего и не любят рутину. Пятерки обладают живым умом, любознательностью и способностью быстро адаптироваться к новым обстоятельствам.

Сильные стороны:
- Гибкость и адаптивность
- Коммуникабельность
- Любовь к путешествиям
- Креативность

Слабые стороны:
- Непостоянство
- Импульсивность
- Сложность с обязательствами
```

### Позиция матрицы

```
Заголовок: Число дня 5: Динамичность и общение
Категория: matrix_position
Язык: ru
Связанное значение: matrix_dayNumber_5

Содержание:
Число дня 5 указывает на динамичную и общительную натуру. Вы рождены для общения, путешествий и новых впечатлений. Ваша энергия направлена на познание мира и взаимодействие с людьми.
```

### Ячейка квадрата

```
Заголовок: Цифра 1 (3 повторения): Сильная воля
Категория: square_cell
Язык: ru
Связанное значение: square_1_3

Содержание:
Три единицы в квадрате Пифагора указывают на сильную волю и лидерские качества. Вы обладаете уверенностью в себе и способностью вести за собой других. Однако важно не переходить в авторитарность.
```

## Многоязычность

Для каждого значения нужно создать статьи на обоих языках:
- `ru` - русский язык
- `en` - английский язык

Компонент `Calculator` автоматически использует текущий язык интерфейса (`locale`) для загрузки статей.

## Производительность

### Кеширование

Статьи загружаются только после выполнения расчетов и кешируются в состоянии компонента.

### Параллельная загрузка

Все статьи для матрицы и квадрата загружаются параллельно с использованием `Promise.all` (неявно через `await` в цикле).

### Оптимизация запросов

ArticleService использует индексы базы данных:
- `@@index([relatedValue])` - быстрый поиск по связанному значению
- `@@index([category, language])` - фильтрация по категории и языку

## Безопасность

### Доступ к статьям

- Статьи для числа судьбы доступны всем пользователям
- Статьи для матрицы судьбы доступны всем пользователям
- Статьи для квадрата Пифагора доступны только пользователям с полным доступом

### Валидация

- `relatedValue` валидируется на уровне API
- Язык ограничен значениями `ru` и `en`
- Категория ограничена значениями `destiny_number`, `matrix_position`, `square_cell`

## Устранение неполадок

### Статья не отображается

1. Проверить, что статья создана в админ панели
2. Проверить правильность `relatedValue`
3. Проверить соответствие языка
4. Проверить логи браузера на наличие ошибок

### Ошибка загрузки статей

1. Проверить подключение к базе данных
2. Проверить логи сервера
3. Проверить правильность API запроса

### Статьи не обновляются

1. Очистить кеш браузера
2. Перезапустить сервер разработки
3. Проверить, что изменения сохранены в базе данных

## Дополнительные ресурсы

- [Документация по AdminService](./admin-api-endpoints.md)
- [Документация по API статей](./admin-api-endpoints.md#статьи)
- [Prisma документация](https://www.prisma.io/docs/)
