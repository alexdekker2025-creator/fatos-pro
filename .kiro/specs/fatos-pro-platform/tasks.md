# План реализации: FATOS.pro

## Обзор

Реализация веб-платформы для нумерологических расчетов на базе Next.js 14 с TypeScript, TailwindCSS и PostgreSQL. Платформа включает три типа расчетов (Квадрат Пифагора, Число Судьбы, Матрица Судьбы), многоязычность, интеграцию с платежными системами и административную панель.

## Задачи

- [x] 1. Инициализация проекта и базовая настройка
  - Создать Next.js 14 проект с App Router и TypeScript
  - Настроить TailwindCSS для стилизации
  - Настроить Prisma ORM и подключение к PostgreSQL
  - Создать базовую структуру директорий (app, components, lib, types)
  - Настроить конфигурацию для деплоя на Netlify
  - _Требования: 1.1, 1.2, 1.3, 1.4, 17.1, 17.2_

- [x] 2. Настройка многоязычности
  - Установить и настроить next-intl для поддержки русского и английского языков
  - Создать файлы переводов для обоих языков (messages/ru.json, messages/en.json)
  - Настроить middleware для определения языка по умолчанию из браузера
  - Реализовать компонент переключателя языка
  - _Требования: 2.1, 2.2, 2.3, 2.4_

- [ ]* 2.1 Написать property-тест для переключения языка
  - **Свойство 1: Переключение языка обновляет интерфейс**
  - **Валидирует: Требование 2.2**

- [ ]* 2.2 Написать property-тест для персистентности языка
  - **Свойство 2: Персистентность выбора языка**
  - **Валидирует: Требование 2.3**

- [x] 3. Создание UI-компонентов
  - Создать компонент Button с вариантами (primary, secondary, outline)
  - Создать компонент Input с валидацией и отображением ошибок
  - Создать компонент Card для карточек контента
  - Создать компонент Modal для модальных окон
  - Обеспечить адаптивность всех компонентов для мобильных и десктопных устройств
  - _Требования: 8.1, 8.2, 8.3, 8.4, 8.5, 8.6, 18.1, 18.2, 18.4_

- [ ]* 3.1 Написать unit-тесты для UI-компонентов
  - Тестировать рендеринг, взаимодействие и состояния компонентов
  - _Требования: 8.1, 8.2, 8.3, 8.4_

- [x] 4. Реализация модуля валидации дат и имени
  - Создать Zod-схему для валидации даты рождения (BirthDateSchema)
  - Реализовать функцию validateBirthDate с проверкой корректности даты
  - Добавить проверку диапазона дат (1900 - текущий год)
  - Добавить проверку на будущие даты
  - Реализовать функцию sumNameLetters(name: string): number для перевода букв в числа (А=1, Б=2, ... Я=33)
  - Добавить хранение имени в состоянии калькулятора
  - Реализовать обработку ошибок валидации с понятными сообщениями
  - _Требования: 3.1, 3.2, 3.3, 3.5_

- [ ]* 4.1 Написать unit-тесты для валидации дат
  - Тестировать корректные даты, некорректные даты (31 февраля), будущие даты, даты до 1900
  - _Требования: 3.2, 3.3, 3.5_

- [ ]* 4.2 Написать property-тест для отклонения некорректных дат
  - **Свойство 3: Отклонение некорректных дат**
  - **Валидирует: Требование 3.2**

- [ ]* 4.3 Написать property-тест для инициации расчетов
  - **Свойство 4: Инициация расчетов для корректных дат**
  - **Валидирует: Требования 3.4, 3.5**

- [x] 4.5 Реализация алгоритмов 4 арканов дня
  - Создать модуль lib/arcana/arcanaCalculator.ts
  - Реализовать метод calculateMorning(birthDay: number): number (день рождения, приведённый к 1-22)
  - Реализовать метод calculateDay(currentDate: Date): number (сумма цифр текущей даты, приведённая к 1-22)
  - Реализовать метод calculateEvening(nameSum: number, morning: number, day: number): number (имя + утро + день, приведение)
  - Реализовать метод calculateNight(day: number, evening: number): number
  - Правило приведения: если >22, вычитать 22, пока не войдёт в 1-22. Если 0 -> вернуть 22 (Шут)
  - _Требования: Новая функциональность - Карта дня_

- [x] 5. Реализация калькулятора Квадрата Пифагора
  - Создать класс PythagoreanCalculator
  - Реализовать метод calculateWorkingNumbers для вычисления четырех рабочих чисел
  - Реализовать алгоритм вычисления первого рабочего числа (сумма всех цифр даты)
  - Реализовать алгоритм вычисления второго рабочего числа (сумма цифр первого)
  - Реализовать алгоритм вычисления третьего рабочего числа (разность первого и удвоенной первой цифры дня)
  - Реализовать алгоритм вычисления четвертого рабочего числа (сумма цифр третьего)
  - Реализовать метод buildSquare для построения сетки 3x3 с подсчетом цифр
  - _Требования: 4.1, 4.2, 4.3, 4.4, 4.5, 5.2, 5.3_

- [ ]* 5.1 Написать property-тест для идемпотентности рабочих чисел
  - **Свойство 5: Идемпотентность вычисления рабочих чисел**
  - **Валидирует: Требования 4.1, 4.2, 4.3, 4.4, 4.5, 4.6**

- [ ]* 5.2 Написать property-тест для корректности квадрата Пифагора
  - **Свойство 6: Корректность построения квадрата Пифагора**
  - **Валидирует: Требования 5.2, 5.3**

- [x] 6. Реализация калькулятора Числа Судьбы
  - Создать класс DestinyCalculator
  - Реализовать метод calculateDestinyNumber с итеративным суммированием цифр
  - Добавить обработку мастер-чисел (11, 22, 33)
  - Реализовать метод для получения описания числа судьбы из базы статей
  - _Требования: 6.1, 6.2, 6.3_

- [ ]* 6.1 Написать property-тест для идемпотентности числа судьбы
  - **Свойство 7: Идемпотентность вычисления числа судьбы**
  - **Валидирует: Требования 6.1, 6.2, 6.4**

- [ ]* 6.2 Написать property-тест для наличия описания числа судьбы
  - **Свойство 8: Наличие описания для числа судьбы**
  - **Валидирует: Требование 6.3**

- [x] 7. Реализация калькулятора Матрицы Судьбы
  - Расширить класс DestinyCalculator методом calculateDestinyMatrix
  - Реализовать вычисление ключевых позиций матрицы на основе даты рождения
  - Создать структуру данных для хранения позиций и их значений
  - Реализовать метод для получения описаний позиций матрицы
  - _Требования: 7.1, 7.2, 7.3, 7.4_

- [ ]* 7.1 Написать property-тест для вычисления матрицы судьбы
  - **Свойство 9: Вычисление матрицы судьбы**
  - **Валидирует: Требования 7.1, 7.2**

- [ ]* 7.2 Написать property-тест для наличия описаний позиций матрицы
  - **Свойство 10: Наличие описаний для позиций матрицы**
  - **Валидирует: Требование 7.4**

- [x] 8. Создание компонента Calculator с Картой дня
  - Создать React-компонент Calculator с формой ввода даты и имени
  - Реализовать состояние компонента (дата, имя, результаты, ошибки)
  - Интегрировать валидацию даты с отображением ошибок
  - Подключить калькуляторы для выполнения расчетов
  - Реализовать отображение результатов (рабочие числа, квадрат, число судьбы, матрица)
  - Создать отдельный блок "Карта дня" с 4 арканами (утро, день, вечер, ночь)
  - Реализовать анимацию переворота карт (flip) и эффект свечения
  - Добавить кнопку сохранения результатов для зарегистрированных пользователей
  - _Требования: 3.1, 3.2, 3.4, 5.1, 6.3, 7.3, Карта дня_

- [x] 8.5 Реализация коллекции арканов
  - При каждом расчете Карты дня сохранять новые уникальные арканы в БД (модель CollectedArcana)
  - Создать API-эндпоинт POST /api/arcana/collect для сохранения арканов
  - Создать API-эндпоинт GET /api/arcana/collection для получения коллекции пользователя
  - Создать компонент прогресс-бара "Коллекция арканов" для профиля (показывает X/22 собранных)
  - Реализовать визуализацию собранных и несобранных арканов
  - _Требования: Новая функциональность - Коллекция арканов_

- [x] 9. Реализация кеширования результатов расчетов
  - Создать модуль кеширования в памяти для результатов расчетов
  - Реализовать функцию генерации ключа кеша на основе даты рождения
  - Добавить проверку кеша перед выполнением расчетов
  - Реализовать сохранение результатов в кеш после вычисления
  - _Требования: 19.2, 19.3_

- [ ]* 9.1 Написать property-тест для кеширования результатов
  - **Свойство 24: Кеширование результатов расчетов**
  - **Валидирует: Требование 19.2**

- [x] 10. Контрольная точка - Проверка работы калькуляторов
  - Убедиться, что все тесты проходят успешно
  - Проверить работу калькуляторов в браузере
  - Задать вопросы пользователю при необходимости

- [x] 13. Реализация сервиса аутентификации
  - Создать класс AuthService с методами register, login, logout, verifySession
  - Реализовать хеширование паролей с использованием bcrypt
  - Реализовать метод verifyPassword для проверки паролей
  - Создать Zod-схему для валидации регистрационных данных
  - Реализовать создание и верификацию сессий
  - _Требования: 9.2, 9.3, 9.4, 20.2_

- [ ]* 13.1 Написать property-тест для создания пользователя
  - Сгенерировать миграцию Prisma на основе схемы
  - Применить миграцию к базе данных PostgreSQL
  - Проверить создание всех таблиц и индексов
  - _Требования: 1.3, 17.3_

- [ ] 13. Реализация сервиса аутентификации
  - Создать класс AuthService с методами register, login, logout, verifySession
  - Реализовать хеширование паролей с использованием bcrypt
  - Реализовать метод verifyPassword для проверки паролей
  - Создать Zod-схему для валидации регистрационных данных
  - Реализовать создание и верификацию сессий
  - _Требования: 9.2, 9.3, 9.4, 20.2_

- [ ]* 13.1 Написать property-тест для создания пользователя
  - **Свойство 11: Создание пользователя при регистрации**
  - **Валидирует: Требования 9.2, 9.3, 20.2**

- [ ]* 13.2 Написать property-тест для уникальности email
  - **Свойство 12: Уникальность email пользователей**
  - **Валидирует: Требование 9.4**

- [x] 14. Создание API-эндпоинтов для аутентификации
  - Создать POST /api/auth/register для регистрации пользователей
  - Создать POST /api/auth/login для входа пользователей
  - Создать POST /api/auth/logout для выхода из системы
  - Добавить обработку ошибок и валидацию входных данных
  - _Требования: 9.2, 9.4_

- [x] 15. Создание API-эндпоинтов для расчетов
  - Создать POST /api/calculations для сохранения расчетов
  - Создать GET /api/calculations для получения истории расчетов пользователя
  - Добавить проверку аутентификации для сохранения расчетов
  - Реализовать связывание расчетов с userId
  - _Требования: 10.2, 10.3, 10.4_

- [ ]* 15.1 Написать property-тест для сохранения расчетов
  - **Свойство 13: Сохранение расчетов зарегистрированных пользователей**
  - **Валидирует: Требования 10.2, 10.3**

- [x] 16. Интеграция аутентификации в интерфейс
  - Создать React Hook useAuth для управления состоянием аутентификации
  - Создать компонент AuthModal с формами входа и регистрации
  - Создать компонент AuthButton для отображения кнопок входа/выхода
  - Интегрировать компоненты на главные страницы (ru/en)
  - Добавить условное отображение ссылок на профиль для авторизованных пользователей
  - _Требования: 9.1, 9.2_

- [x] 17. Создание страницы истории расчетов
  - Создать React Hook useCalculations для работы с API расчетов
  - Создать компонент CalculationCard для отображения карточки расчета
  - Создать страницы /ru/history и /en/history с пагинацией
  - Добавить ссылки на историю на главные страницы
  - Интегрировать автосохранение расчетов в компонент Calculator
  - _Требования: 10.1, 10.2, 10.3_

- [x] 18. Реализация сервиса платежей - базовая структура
  - Создать интерфейс PaymentProvider с методами createSession, verifyWebhook, processWebhook
  - Создать типы PaymentSession и PaymentResult
  - Создать класс PaymentFactory для выбора провайдера на основе региона
  - _Требования: 14.1, 15.1_

- [x] 19. Интеграция с ЮKassa
  - Создать класс YuKassaProvider, реализующий PaymentProvider
  - Реализовать метод createSession для создания платежной сессии в ЮKassa
  - Реализовать метод verifyWebhook для верификации подписи вебхуков
  - Реализовать метод processWebhook для обработки уведомлений о платежах
  - Добавить обработку ошибок и логирование
  - _Требования: 14.2, 14.3, 14.5_

- [ ]* 19.1 Написать property-тест для верификации вебхуков ЮKassa
  - **Свойство 20: Верификация подписи вебхуков ЮKassa**
  - **Валидирует: Требования 14.5, 16.1, 16.2**

- [x] 20. Интеграция со Stripe
  - Создать класс StripeProvider, реализующий PaymentProvider
  - Реализовать метод createSession для создания платежной сессии в Stripe
  - Реализовать метод verifyWebhook для верификации подписи вебхуков
  - Реализовать метод processWebhook для обработки уведомлений о платежах
  - Добавить обработку ошибок и логирование
  - _Требования: 15.2, 15.3, 15.5_

- [ ]* 20.1 Написать property-тест для верификации вебхуков Stripe
  - **Свойство 21: Верификация подписи вебхуков Stripe**
  - **Валидирует: Требования 15.5, 16.1, 16.2**

- [x] 21. Создание API-эндпоинтов для платежей
  - Создать POST /api/payments/create для инициации платежа
  - Реализовать создание заказа со статусом PENDING
  - Реализовать выбор платежного провайдера на основе региона пользователя
  - Реализовать создание платежной сессии и возврат URL для перенаправления
  - _Требования: 11.2, 14.2, 14.3, 15.2, 15.3_

- [x]* 21.1 Написать property-тест для создания заказа
  - **Свойство 14: Создание заказа при инициации оплаты**
  - **Валидирует: Требование 11.2**

- [ ]* 21.2 Написать property-тест для создания платежной сессии
  - **Свойство 19: Создание платежной сессии**
  - **Валидирует: Требования 14.2, 14.3, 15.2, 15.3**

- [x] 22. Создание API-эндпоинтов для вебхуков
  - Создать POST /api/webhooks/yukassa для обработки вебхуков ЮKassa
  - Создать POST /api/webhooks/stripe для обработки вебхуков Stripe
  - Реализовать верификацию подписи вебхуков
  - Реализовать обновление статуса заказа на COMPLETED или FAILED
  - Реализовать идемпотентность обработки вебхуков
  - Реализовать возврат HTTP 200 OK после успешной обработки
  - Добавить логирование попыток с неверной подписью
  - _Требования: 14.4, 14.5, 15.4, 15.5, 16.1, 16.2, 16.3, 16.4, 16.5, 16.6_

- [ ]* 20.1 Написать property-тест для обновления статуса при успешном платеже
  - **Свойство 15: Обновление статуса заказа при успешном платеже**
  - **Валидирует: Требования 11.3, 16.3**

- [ ]* 20.2 Написать property-тест для обновления статуса при неудачном платеже
  - **Свойство 16: Обновление статуса заказа при неудачном платеже**
  - **Валидирует: Требования 11.4, 16.4**

- [ ]* 20.3 Написать property-тест для ответа 200 OK на вебхуки
  - **Свойство 22: Ответ 200 OK на успешно обработанные вебхуки**
  - **Валидирует: Требование 16.5**

- [ ]* 22.4 Написать property-тест для идемпотентности вебхуков
  - **Свойство 23: Идемпотентность обработки вебхуков**
  - **Валидирует: Требование 16.6**

- [x] 23. Контрольная точка - Проверка работы платежной системы
  - Убедиться, что все тесты проходят успешно
  - Проверить создание заказов и обработку вебхуков
  - Задать вопросы пользователю при необходимости

- [x] 24. Реализация сервиса администрирования
  - Создать класс AdminService с методами для управления статьями
  - Реализовать метод createArticle для создания статей
  - Реализовать метод updateArticle для редактирования статей
  - Реализовать метод deleteArticle для удаления статей
  - Реализовать метод getStatistics для получения статистики платформы
  - Реализовать метод logAction для логирования действий администратора
  - _Требования: 12.2, 13.3, 13.4, 13.5_

- [ ]* 22.1 Написать property-тест для логирования действий администратора
  - **Свойство 18: Логирование действий администратора**
  - **Валидирует: Требование 13.5**

- [x] 23. Создание API-эндпоинтов для администрирования
  - Создать GET /api/admin/articles для получения списка статей
  - Создать POST /api/admin/articles для создания статей
  - Создать PUT /api/admin/articles/[id] для редактирования статей
  - Создать DELETE /api/admin/articles/[id] для удаления статей
  - Создать GET /api/admin/statistics для получения статистики
  - Добавить проверку прав администратора для всех эндпоинтов
  - _Требования: 12.2, 13.2, 13.3, 13.4_

- [x] 24. Создание административной панели
  - Создать страницу /admin с проверкой прав доступа
  - Создать интерфейс для управления статьями (список, создание, редактирование, удаление)
  - Создать интерфейс для просмотра статистики платформы
  - Реализовать формы с валидацией для создания и редактирования статей
  - _Требования: 13.1, 13.2, 13.3, 13.4_

- [x] 25. Реализация связывания статей с результатами расчетов
  - Создать функцию для получения статей по relatedValue
  - Интегрировать отображение статей в компонент Calculator
  - Реализовать отображение описаний для чисел судьбы
  - Реализовать отображение описаний для позиций матрицы
  - Реализовать отображение описаний для ячеек квадрата Пифагора
  - _Требования: 12.3, 12.4, 6.3, 7.4_

- [x] 25.1 Написать property-тест для связывания статей
  - **Свойство 17: Связывание статей с нумерологическими значениями**
  - **Валидирует: Требования 12.3, 12.4**

- [x] 26. Реализация адаптивного дизайна
  - Настроить TailwindCSS breakpoints для мобильных, планшетов и десктопов
  - Адаптировать компонент Calculator для мобильных устройств
  - Адаптировать отображение Квадрата Пифагора для малых экранов
  - Обеспечить минимальный размер интерактивных элементов 44x44px
  - Протестировать отображение на различных разрешениях (320px - 2560px)
  - _Требования: 18.1, 18.2, 18.3, 18.4_

- [x] 27. Реализация мер безопасности
  - Настроить HTTPS для всех соединений (конфигурация Netlify)
  - Реализовать защиту от CSRF-атак для API-эндпоинтов
  - Реализовать валидацию и санитизацию всех пользовательских вводов
  - Реализовать rate limiting для предотвращения DDoS-атак
  - Настроить переменные окружения для секретных ключей
  - Добавить проверку безопасности паролей (минимум 8 символов)
  - _Требования: 20.1, 20.2, 20.3, 20.4, 20.5, 20.6_

- [ ]* 27.1 Написать property-тест для валидации пользовательских вводов
  - **Свойство 25: Валидация пользовательских вводов**
  - **Валидирует: Требование 20.4**

- [ ] 28. Создание обработчика ошибок
  - Создать middleware errorHandler для централизованной обработки ошибок
  - Реализовать классы ошибок (ValidationError, AuthenticationError, PaymentError, DatabaseError)
  - Реализовать логирование ошибок с деталями
  - Реализовать retry-механизм для внешних сервисов
  - Добавить обработку ошибок платежных систем с отправкой алертов
  - _Требования: Обработка ошибок из дизайна_

- [ ] 29. Настройка деплоя на Netlify
  - Создать netlify.toml с конфигурацией сборки
  - Настроить серверные функции для API-эндпоинтов
  - Настроить переменные окружения в Netlify Dashboard
  - Настроить автоматический деплой при push в main ветку
  - Проверить подключение к внешней PostgreSQL базе данных
  - _Требования: 17.1, 17.2, 17.3, 17.4, 17.5_

- [x] 30. Создание начальных данных (seed)
  - Создать скрипт для заполнения базы данных начальными статьями
  - Добавить описания для всех чисел судьбы (1-9, 11, 22, 33) на русском и английском
  - Добавить описания для основных позиций матрицы судьбы
  - Добавить описания для ячеек квадрата Пифагора
  - Запустить скрипт для заполнения базы данных
  - _Требования: 6.3, 7.4, 12.1_

- [x] 31. Интеграционное тестирование
  - Написать интеграционный тест для полного потока расчетов
  - Написать интеграционный тест для регистрации и аутентификации
  - Написать интеграционный тест для создания и обработки платежа
  - Написать интеграционный тест для административных операций
  - _Требования: Стратегия тестирования из дизайна_

- [ ] 32. Финальная контрольная точка
  - Убедиться, что все тесты проходят успешно
  - Проверить работу всех функций платформы в браузере
  - Проверить адаптивность на различных устройствах
  - Проверить производительность расчетов (< 500ms)
  - Задать вопросы пользователю при необходимости

- [ ] 33. Настройка PWA (Progressive Web App)
  - Создать манифест приложения (manifest.json) с иконками и метаданными
  - Настроить service worker для кеширования ресурсов и офлайн-режима
  - Добавить мета-теги для PWA в layout
  - Настроить стратегию кеширования (cache-first для статики, network-first для API)
  - Протестировать установку PWA на мобильных устройствах
  - _Требования: Новая функциональность - PWA_

- [ ] 34. Реализация push-уведомлений с картой дня
  - Установить и настроить web-push или аналогичную библиотеку
  - Создать API-эндпоинт POST /api/notifications/subscribe для подписки на уведомления
  - Создать API-эндпоинт POST /api/notifications/send для отправки уведомлений
  - Реализовать ежедневную отправку уведомлений с картой дня (утренний аркан)
  - Создать UI для управления подпиской на уведомления в настройках профиля
  - Добавить обработку разрешений браузера на уведомления
  - _Требования: Новая функциональность - Push-уведомления_

## Примечания

- Задачи, помеченные `*`, являются опциональными и могут быть пропущены для более быстрого MVP
- Каждая задача ссылается на конкретные требования для отслеживаемости
- Контрольные точки обеспечивают инкрементальную валидацию
- Property-тесты валидируют универсальные свойства корректности
- Unit-тесты валидируют конкретные примеры и граничные случаи
